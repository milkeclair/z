# アーキテクチャ図解: z ライブラリの構造

## システム全体図

```
┌─────────────────────────────────────────────────────────┐
│                     z Library                           │
│                                                         │
│  ┌───────────────────────────────────────────────┐    │
│  │              main.zsh (エントリポイント)        │    │
│  │                                               │    │
│  │  1. 環境変数設定 (z_root)                      │    │
│  │  2. モジュールマッピング定義                    │    │
│  │  3. 動的モジュールロード                        │    │
│  │  4. install/uninstall 機能読み込み             │    │
│  └───────────────────────────────────────────────┘    │
│                         │                               │
│                         ▼                               │
│  ┌───────────────────────────────────────────────┐    │
│  │          10 個のコアモジュール                  │    │
│  │                                               │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐       │    │
│  │  │   arg   │  │   arr   │  │  common │       │    │
│  │  └─────────┘  └─────────┘  └─────────┘       │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐       │    │
│  │  │  debug  │  │   dir   │  │  file   │       │    │
│  │  └─────────┘  └─────────┘  └─────────┘       │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐       │    │
│  │  │   int   │  │   io    │  │   str   │       │    │
│  │  └─────────┘  └─────────┘  └─────────┘       │    │
│  │  ┌─────────┐                                  │    │
│  │  │    t    │ (テストフレームワーク)             │    │
│  │  └─────────┘                                  │    │
│  └───────────────────────────────────────────────┘    │
│                                                         │
│  ┌───────────────────────────────────────────────┐    │
│  │          インストール/管理機能                  │    │
│  │                                               │    │
│  │  ┌──────────────┐  ┌──────────────────┐       │    │
│  │  │ install.zsh  │  │ uninstall.zsh    │       │    │
│  │  └──────────────┘  └──────────────────┘       │    │
│  └───────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## モジュール構造の3層アーキテクチャ

```
各モジュール (arg, arr, dir, file, int, str)
│
├── analysis.zsh (分析層)
│   ├── データを変更せずに分析
│   ├── 戻り値: REPLY 変数
│   └── 例: z.arr.count, z.arg.get
│
├── operator.zsh (演算層)
│   ├── 真偽値判定
│   ├── 戻り値: return (0 or 1)
│   └── 例: z.int.gt, z.arr.is_empty
│
└── process.zsh (処理層)
    ├── データの変更・加工
    ├── 戻り値: REPLY 変数
    └── 例: z.str.indent, z.arr.join
```

## データフローパターン

### パターン1: Analysis → Operator チェーン

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 入力データ │ ──→ │ Analysis │ ──→ │ Operator │ ──→ 真偽値
└──────────┘     └──────────┘     └──────────┘
                      │                  ▲
                      ▼                  │
                    REPLY ───────────────┘

例:
z.arr.count $@           # REPLY に要素数
z.int.gt $REPLY 2        # REPLY の値で比較
```

### パターン2: Process → Analysis チェーン

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 入力データ │ ──→ │ Process  │ ──→ │ Analysis │ ──→ REPLY
└──────────┘     └──────────┘     └──────────┘
                      │                  ▲
                      ▼                  │
                    REPLY ───────────────┘

例:
z.str.split "a|b|c" "|" # REPLY に配列
z.arr.count $REPLY       # REPLY に要素数
```

## テストフレームワーク構造

```
┌───────────────────────────────────────────────────┐
│                  z.t (テストランナー)               │
│                                                   │
│  ┌─────────────────────────────────────────┐    │
│  │         テスト探索エンジン                │    │
│  │                                         │    │
│  │  1. パターンマッチング (**/*_test.zsh)    │    │
│  │  2. フィルタリング (-f, -l オプション)     │    │
│  │  3. テストファイル実行                    │    │
│  └─────────────────────────────────────────┘    │
│                      │                           │
│                      ▼                           │
│  ┌─────────────────────────────────────────┐    │
│  │           DSL (BDD スタイル)             │    │
│  │                                         │    │
│  │  z.t.describe ────┐                     │    │
│  │                   │                     │    │
│  │  z.t.context ─────┼─> test_logs[]       │    │
│  │                   │                     │    │
│  │  z.t.it ──────────┘                     │    │
│  │                                         │    │
│  │  z.t.expect                             │    │
│  │  z.t.expect_reply                       │    │
│  │  z.t.expect_include                     │    │
│  └─────────────────────────────────────────┘    │
│                      │                           │
│                      ▼                           │
│  ┌─────────────────────────────────────────┐    │
│  │         レポート生成                     │    │
│  │                                         │    │
│  │  ├── current_indexes (位置追跡)          │    │
│  │  ├── failure_records (失敗記録)          │    │
│  │  ├── カラーリング (ANSI エスケープ)       │    │
│  │  └── トラップによるクリーンアップ          │    │
│  └─────────────────────────────────────────┘    │
└───────────────────────────────────────────────────┘
```

## デバッガのアーキテクチャ

```
┌──────────────────────────────────────────┐
│          z.debug (デバッガ)              │
│                                          │
│  1. REPLY の保存                         │
│           │                              │
│           ▼                              │
│  2. REPL ループ                          │
│     ┌────────────────────────────┐      │
│     │  入力待機                   │      │
│     │     │                      │      │
│     │     ▼                      │      │
│     │  コマンド解析                │      │
│     │  ├── c/continue → 継続      │      │
│     │  ├── p/print → 変数表示     │      │
│     │  ├── h/help → ヘルプ       │      │
│     │  ├── q/quit → 終了         │      │
│     │  └── * → eval 実行         │      │
│     └────────────────────────────┘      │
│           │                              │
│           ▼                              │
│  3. REPLY の復元                         │
└──────────────────────────────────────────┘
```

## インストールフロー

```
┌─────────────────────────────────────────────────┐
│              z.install                          │
│                                                 │
│  1. ユーザー入力                                 │
│     └─> install_dir (デフォルト: ~/.z)          │
│                                                 │
│  2. 上書き確認                                   │
│     └─> z.install._question_overwrite_install_dir│
│                                                 │
│  3. 一時ディレクトリ作成                          │
│     └─> z.install._create_temp_dir              │
│                                                 │
│  4. GitHub からダウンロード                      │
│     └─> curl -sL github.com/.../archive/...     │
│                                                 │
│  5. アーカイブ解凍                               │
│     └─> tar -xzf                                │
│                                                 │
│  6. ファイルコピー                               │
│     └─> cp -r source/* install_dir/             │
│                                                 │
│  7. .zshrc への追加 (オプション)                  │
│     └─> z.install._add_to_zshrc                 │
│                                                 │
│  8. クリーンアップ                               │
│     └─> rm -rf temp_dir                         │
└─────────────────────────────────────────────────┘
```

## REPLY パターンの伝播

```
関数A                    関数B                    関数C
  │                        │                        │
  ├─> データ処理             │                        │
  │                        │                        │
  ├─> REPLY = 結果          │                        │
  │                        │                        │
  └────────────────────>  ├─> $REPLY を使用         │
                           │                        │
                           ├─> 追加処理              │
                           │                        │
                           ├─> REPLY = 新しい結果    │
                           │                        │
                           └─────────────────────> ├─> $REPLY を使用
                                                    │
                                                    └─> 最終処理

例:
z.arr.count "a" "b" "c"  # REPLY = 3
z.int.gt $REPLY 2        # $REPLY (3) > 2 をチェック
```

## 名前空間の階層

```
z (ルート名前空間)
│
├── arg (引数操作)
│   ├── analysis
│   │   ├── z.arg.get
│   │   └── z.arg.first
│   ├── operator
│   │   ├── z.arg.has
│   │   └── z.arg.has_not_any
│   └── process
│       └── z.arg.as
│
├── arr (配列操作)
│   ├── analysis
│   │   └── z.arr.count
│   ├── operator
│   │   ├── z.arr.is_empty
│   │   └── z.arr.has
│   └── process
│       └── z.arr.join
│
├── common (共通機能)
│   ├── dsl
│   │   ├── z.group
│   │   └── z.guard
│   ├── operator
│   │   ├── z.is_true
│   │   ├── z.is_false
│   │   ├── z.eq
│   │   └── z.is_null
│   └── wrap
│       └── z.return
│
├── debug (デバッグ)
│   └── process
│       ├── z.debug
│       ├── z.debug.enable
│       └── z.debug.disable
│
├── dir (ディレクトリ)
│   ├── operator
│   │   ├── z.dir.is
│   │   └── z.dir.is_not
│   └── process
│       └── z.dir.create
│
├── file (ファイル)
│   ├── operator
│   │   ├── z.file.is
│   │   └── z.file.is_not
│   └── process
│       └── z.file.create
│
├── int (整数)
│   └── operator
│       ├── z.int.is
│       ├── z.int.eq
│       ├── z.int.gt
│       ├── z.int.lt
│       └── z.int.is_zero
│
├── io (入出力)
│   └── process
│       ├── z.io
│       ├── z.io.error
│       ├── z.io.empty
│       ├── z.io.read
│       └── z.io.clear
│
├── str (文字列)
│   ├── color
│   │   ├── z.str.color.red
│   │   ├── z.str.color.green
│   │   └── z.str.color.yellow
│   ├── operator
│   │   └── z.str.is_path_like
│   └── process
│       ├── z.str.indent
│       ├── z.str.split
│       └── z.str.gsub
│
└── t (テスト)
    ├── dsl
    │   ├── z.t.describe
    │   ├── z.t.context
    │   ├── z.t.it
    │   ├── z.t.expect
    │   └── z.t.teardown
    └── process
        └── z.t (テストランナー)
```

## モジュール間の依存関係

```
                    common (基盤)
                    ┌───────┐
                    │operator│
                    │  wrap  │
                    │  dsl   │
                    └───┬───┘
                        │
           ┌────────────┼────────────┐
           ▼            ▼            ▼
      ┌────────┐   ┌────────┐   ┌────────┐
      │  arg   │   │  arr   │   │  int   │
      └────────┘   └────────┘   └────────┘
           │            │            │
           └────────────┼────────────┘
                        ▼
                   ┌────────┐
                   │  str   │
                   └────────┘
                        │
           ┌────────────┼────────────┐
           ▼            ▼            ▼
      ┌────────┐   ┌────────┐   ┌────────┐
      │  io    │   │  dir   │   │  file  │
      └────────┘   └────────┘   └────────┘
                        │
           ┌────────────┼────────────┐
           ▼            ▼            ▼
      ┌────────┐   ┌────────┐   ┌────────┐
      │ debug  │   │   t    │   │install │
      └────────┘   └────────┘   └────────┘
```

## ファイルシステム構造

```
z/
├── main.zsh ..................... エントリポイント
├── install.zsh .................. インストールスクリプト
├── uninstall.zsh ................ アンインストールスクリプト
├── zdev ......................... 開発用ウォッチャー
│
├── lib/ ......................... コアライブラリ
│   ├── arg/
│   │   ├── analysis.zsh
│   │   ├── operator.zsh
│   │   └── process.zsh
│   ├── arr/
│   │   ├── analysis.zsh
│   │   ├── operator.zsh
│   │   └── process.zsh
│   ├── common/
│   │   ├── dsl.zsh
│   │   ├── operator.zsh
│   │   └── wrap.zsh
│   ├── debug/
│   │   └── process.zsh
│   ├── dir/
│   │   ├── operator.zsh
│   │   └── process.zsh
│   ├── file/
│   │   ├── operator.zsh
│   │   └── process.zsh
│   ├── int/
│   │   └── operator.zsh
│   ├── io/
│   │   └── process.zsh
│   ├── str/
│   │   ├── color.zsh
│   │   ├── operator.zsh
│   │   └── process.zsh
│   └── t/
│       ├── dsl.zsh
│       └── process.zsh
│
└── test/ ........................ テストスイート
    ├── arg/
    │   ├── analysis_test.zsh
    │   ├── operator_test.zsh
    │   └── process_test.zsh
    ├── arr/
    │   ├── analysis_test.zsh
    │   ├── operator_test.zsh
    │   └── process_test.zsh
    ├── common/
    │   ├── dsl_test.zsh
    │   ├── operator_test.zsh
    │   └── wrap_test.zsh
    ├── debug/
    │   └── process_test.zsh
    ├── dir/
    │   ├── operator_test.zsh
    │   └── process_test.zsh
    ├── file/
    │   ├── operator_test.zsh
    │   └── process_test.zsh
    ├── int/
    │   └── operator_test.zsh
    ├── io/
    │   └── process_test.zsh
    └── str/
        ├── color_test.zsh
        ├── operator_test.zsh
        └── process_test.zsh
```

## エラーハンドリングフロー

```
関数呼び出し
    │
    ▼
┌───────────────┐
│ ガード節       │
│ z.guard; {    │
│   条件チェック │
│   早期リターン │
│ }             │
└───────┬───────┘
        │
        ▼ (条件OK)
┌───────────────┐
│ 型チェック     │
│ z.int.is $val │
│ || return 1   │
└───────┬───────┘
        │
        ▼ (型OK)
┌───────────────┐
│ メイン処理     │
│               │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ REPLY に結果   │
│ z.return $val │
└───────────────┘
```

## まとめ

この図解により、z ライブラリの以下の構造的特徴が明確になります：

1. **階層的モジュール構造**: 明確な3層アーキテクチャ (analysis/operator/process)
2. **一貫した命名規則**: `z.<module>.<type>.<function>` パターン
3. **REPLY パターン**: グローバル変数を使った効率的なデータ伝播
4. **BDD テストフレームワーク**: describe-context-it 構造
5. **モジュール間の適切な依存関係**: common を基盤とした階層的依存

これらの設計により、拡張性と保守性の高いライブラリが実現されています。
